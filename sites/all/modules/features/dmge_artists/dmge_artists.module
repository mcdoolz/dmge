<?php
/**
 * @file
 * Code for the DMGE - Artists feature.
 */

include_once 'dmge_artists.features.inc';

/**
 * If the artist has a link in their profile, it might be a YouTube link.
 * If it IS a YouTube link, then lets go to their channel and download all
 * their videos as unpublished videos on the site.
 * TODO: Build the user a VBO view for publishing videos.
 */

/**
 * Doing this on cron.
 */
function dmge_artists_cron() {
  //
}

function dmge_artists_preprocess_page() {
  global $user;
  if (is_array($user->roles) && in_array('administrator', $user->roles)) {
    dmge_artists_retrieve_uploads();
  }
}
function dmge_artists_retrieve_uploads($channelId = 'UCrsCjHT8tJ1vpSkvLoYji3g') {
  $apiKey = variable_get('youtube_apikey', 'AIzaSyAE_8NGF6cwkpDZ4nKrogAIASzxpdT-gcw');
  $baseUrl = 'https://www.googleapis.com/youtube/v3/';

  $params = [
  'id'=> $channelId,
  'part'=> 'contentDetails',
  'key'=> $apiKey
  ];
  $url = $baseUrl . 'channels?' . http_build_query($params);
  $json = drupal_http_request($url);
  $json = json_decode($json->data, true);

  $playlist = $json['items'][0]['contentDetails']['relatedPlaylists']['uploads'];

  $params = [
    'part'=> 'snippet',
    'playlistId' => $playlist,
    'maxResults'=> '50',
    'key'=> $apiKey,
  ];
  $url = $baseUrl . 'playlistItems?' . http_build_query($params);
  $json = drupal_http_request($url);
  $json = json_decode($json->data, true);

  $videos = [];
  foreach($json['items'] as $video) {
    print_r($video['snippet']);
    $vid = $video['snippet']['resourceId']['videoId'];
    $videos[$vid] = $video['snippet']['resourceId']['videoId'];
  }

  while(isset($json['nextPageToken'])) {
    $nextUrl = $url . '&pageToken=' . $json['nextPageToken'];
    $json = drupal_http_request($nextUrl);
    $json = json_decode($json->data, true);
    foreach($json['items'] as $video) {
      $vid = $video['snippet']['resourceId']['videoId'];
      $videos[$vid] = $video['snippet']['resourceId']['videoId'];
    }
  }
  dpm($videos);
}
